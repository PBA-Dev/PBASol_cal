{% extends "base.html" %}

{% block title %}Manage Events{% endblock %}

{% block content %}
<h1 class="mb-4">Manage Events</h1>
<form id="bulk-delete-form" method="POST" action="{{ url_for('bulk_delete_events') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <table class="table table-striped">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>Name</th>
                <th>Date</th>
                <th>Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for event in events %}
            <tr>
                <td><input type="checkbox" name="event_ids" value="{{ event.id }}"></td>
                <td>{{ event.name }}</td>
                <td>{{ event.date.strftime('%d.%m.%Y') }}</td>
                <td>{{ event.time.strftime('%H:%M') }}</td>
                <td>
                    <a href="{{ url_for('edit_event', event_id=event.id) }}" class="btn btn-sm btn-primary">Edit</a>
                    <button type="button" class="btn btn-sm btn-info duplicate-event" data-event-id="{{ event.id }}">Duplicate</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-danger" id="bulk-delete-btn" disabled>Delete Selected</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all');
    const eventCheckboxes = document.querySelectorAll('input[name="event_ids"]');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const bulkDeleteForm = document.getElementById('bulk-delete-form');
    const duplicateButtons = document.querySelectorAll('.duplicate-event');

    selectAllCheckbox.addEventListener('change', function() {
        eventCheckboxes.forEach(checkbox => checkbox.checked = this.checked);
        updateBulkDeleteButton();
    });

    eventCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkDeleteButton);
    });

    function updateBulkDeleteButton() {
        const checkedCount = Array.from(eventCheckboxes).filter(cb => cb.checked).length;
        bulkDeleteBtn.disabled = checkedCount === 0;
        bulkDeleteBtn.textContent = `Delete Selected (${checkedCount})`;
    }

    bulkDeleteForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const checkedCount = Array.from(eventCheckboxes).filter(cb => cb.checked).length;
        if (checkedCount === 0) {
            alert('Please select at least one event to delete.');
            return;
        }
        if (confirm(`Are you sure you want to delete ${checkedCount} event(s)?`)) {
            this.submit();
        }
    });

    duplicateButtons.forEach(button => {
        button.addEventListener('click', function() {
            const eventId = this.getAttribute('data-event-id');
            fetch(`/duplicate_event/${eventId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to duplicate event. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while duplicating the event.');
            });
        });
    });
});
</script>
{% endblock %}
